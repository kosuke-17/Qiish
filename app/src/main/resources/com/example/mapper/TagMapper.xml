<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.TagMapper">

	<resultMap type="com.example.domain.Tag" id="tagMap">
		<id column="id" property="id"/>
        <result column="skill" property="skill"/>
        <result column="image" property="image"/>
        <result column="tag_count" property="tagCount"/>
	</resultMap>
	
	<!-- Tag情報取得 -->
	<select id="getTags" resultType="com.example.domain.Tag">
		SELECT id, skill FROM tags;
	</select>
	
	<!-- Tagの投稿数を集計（月間・年間・全て） -->
	<select id="getTagsCount" resultMap="tagMap">
		select 
		t.skill, t.image, count(at.tag_id) as tag_count  
		from articles a left join article_tags at on a.id = at.article_id 
		left join  tags t on t.id = at.tag_id 
		<choose>
			<when test='value == "MONTH"'>
				where a.posted_date > date_sub(CURDATE(), interval 30 day )
			</when> 
			<when test='value == "YEAR"'>
				where a.posted_date > date_sub(CURDATE(), interval 365 day )
			</when> 
		</choose>
		group by t.skill order by count(at.tag_id) desc limit 20;
	</select>
	

</mapper>